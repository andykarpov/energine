# Модуль mail

*Данный модуль представляет функциональность, связанную с почтоывыми отправлениями и почтовыми рассылками.*

## Компоненты модуля

1. **MailSubscriptionEditor** - компонент управления почтовыми рассылками. Каждая рассылка представляет собой запись в таблице **mail_subscriptions**. Поле **subscription_type** типа **ENUM** представляет возможность на этапе разработки задать дополнительные типы рассылок (далее смотрите описание **gears/IMailSource**). Например один из вариантов данного поля - значение *news*, которое, как логично предположить - используется для обозначения факта принадлежности рассылки к сущности *"Новости"* для рассылки новостей.

2. **MailTemplateEditor** - компонент управления шаблонами почтовых уведомлений. В разных ситуациях и по разным причинам системе требуется отправить почтовое уведомление по заданному шаблону (например триггер об успешной регистрации пользователя, либо триггер сброса пароля, и тп). Почтовые рассылки также используют данный компонент. Каждая запись из таблицы **mail_templates** представляет из себя именованный почтовый шаблон и имеет поля для задания темы письма, plaintext части письма и html части письма. В шаблоне допускается использование макросов, предусмотренных иднивидуально для каждого шаблона. Перечень макросов описывается в свободной форме вместе с шаблоном в поле *"Подсказки"*.

3. **MailSubscriptionList** - компонент, который служит для управления подписками для зарегистрированных пользователей. Пользователю выводится весь список активных рассылок, напротив каждой есть галочка, с помощью которой пользователь "*подписывается*" на рассылку. Фактически подписка - это добавление записи в таблицу **mail_subscriptions2users**.

## Gears

1. **Mail** - класс для физической отправки сообщения с заданной темой и телом заданному пользователю с заданного email. Является прослойкой для системной фукции *mail()*.

2. **MailTemplate** - класс для получения шаблона из базы по его имени, подстановки заданных данных для макросов шаблона и в итоге - для получения уже подготовленных темы письма, plaintext части письма и html части письма.

3. **MailProcessor** - рассыльщик почтовых рассылок. Вызывается из cli-скрипта **cli/mail_sender.php**. Проверяет периодичность рассылки и дату ее последней рассылки, после чего получает список подписчиков и для каждого формирует персонифицированное письмо с текстом рассылки.

4. **IMailSource** - интерфейс для "*источника данных*" почтовых рассылок. Каждый источник данных (например MailSourceNew для новостей) должен реализовывать данный интерфейс. 

5. **MailSourceFactory** - фабрика для инстанциирования "*источников данных*" по имени (значение поля *mail_subscriptions.subscription_type*). Например **MailSourceFactory::get('news')** вернет объект **MailSourceNews**.

